
This is the complete, structured **"TiDB Intelligent Health Check (tihc)" Design Document**, covering the integration of microkernel architecture and DDD, with a focus on plugin communication, module boundaries, technology choices, and extension strategies.

---

# üìò TiDB Intelligent Health Check (tihc) ‚Äî Architecture Design Document

---

## 1Ô∏è‚É£ Project Goals

`tihc` is a CLI + Web integrated tool platform for DBAs, aiming to provide:

* **TiDB cluster inspection and diagnostics**
* **Slow log and performance analysis**
* **DDL change checking**
* **GitHub bug analysis and alerting**
* **Future root cause analysis (RCA/AWR-like features)**

Supports plugin-based extension, solid domain modeling, cross-platform deployment, and self-contained packaging.

---

## 2Ô∏è‚É£ Core Architectural Principles

| Layer         | Pattern/Approach              | Description                                 |
| ------------- | ---------------------------- | ------------------------------------------- |
| Core Platform | Microkernel Architecture      | Plugin scheduling/lifecycle/interface mgmt   |
| Plugin Design | DDD + Clean Architecture     | Each plugin is a bounded context, single responsibility |
| Plugin Comm   | Service Registry + Event/Command Bus | Decoupled plugin invocation                |
| Startup Mode  | CLI + Web Server             | Single binary, self-contained deployment    |

---

## 3Ô∏è‚É£ Overall Architecture Diagram (Logical View)

```
+-----------------------------------------------------+
|                 CLI / Web Server Entry Point        |
+-----------------------------------------------------+
|              üåê Microkernel Core                    |
| +-----------------------------------------------+ |
| | Core Services                                 | |
| | - ConfigService                               | |
| | - LoggingService (tracing)                    | |
| | - DatabaseService (SQLx)                      | |
| | - MetricsService (Prometheus)                 | |
| | - EventBus / CommandBus                       | |
| | - ServiceRegistry (Plugin Service Registry)   | |
| +-----------------------------------------------+ |
| | Plugin Management (PluginManager)             | |
| | - Plugin discovery/loading/lifecycle mgmt     | |
| | - Plugin hot-reload (future)                  | |
| +-----------------------------------------------+ |
+-----------------------------------------------------+
|                üì¶ Plugin System (DDD Context)      |
| Plugin = Bounded Context, each plugin encapsulates its own domain and services |
| +-------------------------------------------------+ |
| | LossyDDLChecker       | Diagnose lossy DDL risks  | |
| | SlowLogParser         | Parse slow.log and import | |
| | GitHubIssueTracker    | GitHub issue mapping      | |
| | RCAEngine             | Root cause analysis (AWR/ADDM) | |
| | SQL Editor            | Visual SQL editor         | |
| | ProfileCollector      | Profile & metrics capture | |
| | AlertWebhook          | Alert push & config       | |
| +-------------------------------------------------+ |
+-----------------------------------------------------+
|              üß† DDD Layer Structure in Each Plugin  |
| +-----------------------------------------------+ |
| | domain         | Domain model/rules/entities/events| |
| | application    | Use case layer/domain service coordination | |
| | infrastructure | DB/HTTP/Prometheus implementation| |
| | interface      | CLI/Web API layer                | |
| +-----------------------------------------------+ |
+-----------------------------------------------------+
|             üì° External Dependencies/Data Sources (Unified Adapter) |
| +-------------------------------------------------+ |
| | SQLx + TiDB / MySQL / PG                        | |
| | DuckDB embedded analytics DB                    | |
| | Prometheus / Grafana HTTP API                   | |
| | profile API capture (tidb/tikv/pd/ticdc)        | |
| +-------------------------------------------------+ |
```

---

## 4Ô∏è‚É£ Plugin Communication Mechanism

### ‚úÖ Inter-plugin Calls: ServiceRegistry + Dependency Inversion Principle

**Core Idea**:

1. Plugin A defines and implements a `trait` interface (e.g., `DdlCheckerService`).
2. Plugin A registers the interface with the core `ServiceRegistry` during registration.
3. Plugin B obtains the capability via `registry.resolve::<dyn DdlCheckerService>()`.

Thus, **plugins are decoupled and communicate only via trait interfaces**; the core does not depend on concrete plugin implementations.

### üîÅ Plugin Event Propagation: EventBus + CommandBus

* Plugins do not need to be aware of each other; events are broadcast (e.g., DDL event triggers alert plugin).
* CommandBus can be used for CLI/Web to dispatch UseCase handlers in plugins.

---

## 5Ô∏è‚É£ Plugin Directory Structure (Example)

```text
plugin-lossy-ddl/
‚îú‚îÄ‚îÄ domain/
‚îÇ   ‚îú‚îÄ‚îÄ rule.rs
‚îÇ   ‚îî‚îÄ‚îÄ model.rs
‚îú‚îÄ‚îÄ application/
‚îÇ   ‚îî‚îÄ‚îÄ lossy_ddl_service.rs
‚îú‚îÄ‚îÄ infrastructure/
‚îÇ   ‚îî‚îÄ‚îÄ parser_adapter.rs
‚îú‚îÄ‚îÄ interface/
‚îÇ   ‚îî‚îÄ‚îÄ cli.rs / web.rs
‚îú‚îÄ‚îÄ plugin.rs        // Plugin trait implementation + registration
‚îú‚îÄ‚îÄ lib.rs
```

### Plugin Registration Example

```rust
pub struct LossyDdlPlugin;

impl Plugin for LossyDdlPlugin {
    fn name(&self) -> &str { "lossy_ddl" }

    fn register(&mut self, ctx: &mut PluginContext) {
        ctx.register_command("check-lossy-ddl", LossyDdlHandler);
        ctx.service_registry.register::<dyn DdlCheckerService>(Arc::new(LossyDdlServiceImpl));
    }
}
```

---

## 6Ô∏è‚É£ Backend Key Technology Choices

| Module      | Technology                        | Reason                |
| ----------- | -------------------------------- | --------------------- |
| Web Framework | `axum` + `tower`               | High performance, composable |
| ORM         | `sqlx`                           | Zero runtime overhead, async |
| Local Analytics DB | `DuckDB`                   | Supports complex OLAP queries |
| Config Mgmt  | `config` + `serde`              | Multi-source config         |
| Logging      | `tracing`, `anyhow`, `thiserror`| Reliable diagnostics        |
| Metrics      | `prometheus-client`             | Internal observability      |
| Plugin Mgmt  | Custom PluginManager + trait    | Controllable plugin lifecycle |
| API Comm     | JSON REST API + `reqwest`       | Easy integration (e.g. Grafana) |

---

## 7Ô∏è‚É£ Frontend Architecture (Vue 3 + TS)

### üß± Tech Stack

| Technology  | Purpose      |
| ----------- | ------------|
| Vue 3       | UI framework |
| Vite        | Build tool   |
| TypeScript  | Static typing|
| Pinia       | State mgmt   |
| Axios       | HTTP client  |
| Naive UI    | High-quality UI components |
| ECharts     | Charting, diagnostics visualization |

### üìÑ Page Modules

| Page         | Functionality  |
| ------------ | --------------|
| Dashboard    | Overview & status panel |
| Slow Log Analysis | Query/import/aggregation views |
| DDL Safety Check | Check SQL change risks |
| SQL Editor   | Execute/history mgmt |
| Profile Collection | Flamegraph display |
| Webhook Alert Config | Set push channels and rules |

---

## 8Ô∏è‚É£ CLI Command Design

```bash
# CLI mode diagnosis
tihc check lossy-ddl --file ddl.sql

# Start Web service + UI
tihc web --port 8080

# Plugin related
tihc plugin list
tihc plugin run slowlog-parser --file slow.log
```

---

## 9Ô∏è‚É£ Testing Strategy

| Layer          | Test Approach                        |
| -------------- | ------------------------------------|
| Domain         | Unit tests                           |
| Application    | Use case combination tests           |
| Interface      | HTTP/CLI interface tests             |
| Plugin Integration | Plugin load/invoke tests          |
| Core Platform  | PluginManager & ServiceRegistry tests|

---

## üîí 10Ô∏è‚É£ Packaging & Deployment

* Build backend: `cargo build --release`
* Build frontend: `pnpm build`
* Static embedding: use `include_dir!` or `rust-embed`
* Single binary packaging: no external dependencies, supports container deployment

---

## üõ§Ô∏è 11Ô∏è‚É£ Roadmap (Milestones)

| Phase  | Features                                 |
| ------ | -----------------------------------------|
| MVP    | CLI mode, lossy ddl check, slow log parsing, Prometheus metrics |
| Alpha  | Web UI, GitHub Tracker, SQL Editor, Webhook |
| Beta   | Profile collection, Grafana integration, inspection report generation |
| GA     | RCA framework, rule/model-driven inference, plugin marketplace/hot-plug support |

---

## ‚úÖ Architectural Design Principles Summary

* Plugins are DDD bounded contexts: strong consistency, high cohesion, low coupling.
* Microkernel only handles scheduling, registration, logging, config, not business logic.
* Plugin communication is unified via core interfaces (registry + trait).
* All modules are independently testable and support self-contained build/delivery.

---
## Directory Structure

```
tihc/                          # Ê†πÈ°πÁõÆÁõÆÂΩïÔºåRust workspace
‚îú‚îÄ‚îÄ Cargo.toml                 # workspace ÈÖçÁΩÆ
‚îú‚îÄ‚îÄ cli/                      # CLI launcher
‚îÇ   ‚îú‚îÄ‚îÄ Cargo.toml
‚îÇ   ‚îî‚îÄ‚îÄ src/
‚îÇ       ‚îî‚îÄ‚îÄ main.rs           # CLI parsing, core service dispatch
‚îÇ
‚îú‚îÄ‚îÄ core/                     # Core lib: microkernel + DDD + plugin framework
‚îÇ   ‚îú‚îÄ‚îÄ Cargo.toml
‚îÇ   ‚îî‚îÄ‚îÄ src/
‚îÇ       ‚îú‚îÄ‚îÄ domain/           # Domain layer (entities, aggregates, events, rules)
‚îÇ       ‚îú‚îÄ‚îÄ application/      # Application layer (use cases, domain service coordination)
‚îÇ       ‚îú‚îÄ‚îÄ infrastructure/   # Infrastructure (DB, HTTP, external system adapters)
‚îÇ       ‚îú‚îÄ‚îÄ interface/        # Interface layer (CLI adapters, Web API adapters, etc.)
‚îÇ       ‚îú‚îÄ‚îÄ platform/         # Microkernel core (plugin mgmt, event bus, service registry)
‚îÇ       ‚îî‚îÄ‚îÄ plugin_api/       # Plugin public interface definitions (traits, etc.)
‚îÇ
‚îú‚îÄ‚îÄ plugins/                  # Plugin collection, each as an independent crate (DDD context)
‚îÇ   ‚îú‚îÄ‚îÄ plugin_lossy_ddl/     # LossyDDL diagnosis plugin
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Cargo.toml
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ plugin_slowlog/       # Slow log parsing plugin
‚îÇ   ‚îú‚îÄ‚îÄ plugin_github_issue/  # GitHub Issue tracking plugin
‚îÇ   ‚îú‚îÄ‚îÄ plugin_rca_engine/    # Root cause analysis plugin
‚îÇ   ‚îú‚îÄ‚îÄ plugin_sql_editor/    # SQL editor plugin
‚îÇ   ‚îú‚îÄ‚îÄ plugin_profile_collector/ # Profile collection plugin
‚îÇ   ‚îî‚îÄ‚îÄ plugin_alert_webhook/ # Alert webhook plugin
‚îÇ
‚îú‚îÄ‚îÄ backend/                      # Web service launcher, depends on core, provides REST API
‚îÇ   ‚îú‚îÄ‚îÄ Cargo.toml
‚îÇ   ‚îî‚îÄ‚îÄ src/
‚îÇ       ‚îî‚îÄ‚îÄ lib.rs           # Axum service entry point
‚îÇ
‚îú‚îÄ‚îÄ frontend/       # Vue 3 frontend project, managed independently with npm
‚îÇ   ‚îú‚îÄ‚îÄ package.json
‚îÇ   ‚îú‚îÄ‚îÄ vite.config.ts
‚îÇ   ‚îî‚îÄ‚îÄ src/
‚îÇ       ‚îú‚îÄ‚îÄ components/
‚îÇ       ‚îú‚îÄ‚îÄ views/
‚îÇ       ‚îú‚îÄ‚îÄ api/
‚îÇ       ‚îú‚îÄ‚îÄ composables/
‚îÇ       ‚îî‚îÄ‚îÄ main.ts
‚îÇ
‚îú‚îÄ‚îÄ common/                   # Common utility lib (types, helpers, error types, etc.)
‚îÇ   ‚îú‚îÄ‚îÄ Cargo.toml
‚îÇ   ‚îî‚îÄ‚îÄ src/
‚îÇ
‚îú‚îÄ‚îÄ scripts/                  # Scripts (build, release, DB migration, etc.)
‚îÇ
‚îî‚îÄ‚îÄ docs/                     # Design docs, API specs, dev guidelines
```


## ÊñáÊ°£Ê≥®ÈáäËßÑËåÉ
Âü∫Á°ÄÊ†ºÂºè
‰ΩøÁî®‰∏âÊñúÊù† /// ËøõË°åÁªìÊûÑÂåñÊ≥®Èáä„ÄÇ

Ê≥®ÈáäÂøÖÈ°ª‰∏∫ÂÆåÊï¥„ÄÅËßÑËåÉÁöÑËã±ÊñáÂè•Â≠êÔºåÈ¶ñÂ≠óÊØçÂ§ßÂÜôÔºåÁªìÂ∞æ‰ΩøÁî®Âè•Âè∑„ÄÇ

Áªü‰∏Ä‰ΩøÁî® Markdown ËØ≠Ê≥ïÊîØÊåÅÊ†ºÂºèÂåñÔºàrustdoc ÈªòËÆ§ÊîØÊåÅÔºâ„ÄÇ

üìö Ê≥®ÈáäÂØπË±°‰∏éËßÑÂàô
1. ModulesÔºàmodÔºâ
‰ΩøÁî® //! ÊîæÂú®Ê®°ÂùóÊñá‰ª∂ÂºÄÂ§¥ÔºåÊèèËø∞Ê®°ÂùóËÅåË¥£„ÄÅÁî®ÈÄî„ÄÅÊö¥Èú≤ÂÜÖÂÆπ„ÄÇ

rust
Â§çÂà∂
ÁºñËæë
//! Handles the parsing and normalization of slow query logs.
//!
//! This module provides functions to load, analyze, and store
//! slow log entries for further inspection by diagnostic plugins.
2. Struct / Enum / Trait
‚úÖ Struct / Enum
rust
Â§çÂà∂
ÁºñËæë
/// Represents a parsed slow log entry from TiDB or MySQL.
///
/// This structure is populated by the `SlowLogParser` plugin
/// and ingested into DuckDB for analysis.
pub struct SlowLogEntry {
    /// The SQL text of the slow query.
    pub sql: String,

    /// The total execution time in milliseconds.
    pub duration_ms: u64,
}
‚úÖ Trait
rust
Â§çÂà∂
ÁºñËæë
/// Defines a diagnostic service for DDL safety checks.
///
/// Implementors are responsible for detecting risky or lossy
/// DDL patterns that may cause data loss or downtime.
pub trait DdlCheckerService {
    /// Analyzes the given SQL statements for lossy DDL patterns.
    fn check(&self, sql: &str) -> Result<Vec<CheckResult>>;
}
3. Function / Method
‚úÖ ÂÖ¨ÂÖ±ÂáΩÊï∞ÔºàÂåÖÊã¨ async/handlerÔºâ
rust
Â§çÂà∂
ÁºñËæë
/// Runs the lossy DDL check on the specified SQL input.
///
/// Returns a list of detected issues or an empty list if the input is safe.
pub fn check_lossy_ddl(input: &str) -> anyhow::Result<Vec<CheckResult>> { ... }
‚ö†Ô∏è ÁßÅÊúâÂáΩÊï∞Ôºà‰ªÖÂøÖË¶ÅÊó∂Ôºâ
rust
Â§çÂà∂
ÁºñËæë
// Parses an individual SQL statement into an AST node.
// Used internally by the lossy DDL checker.
fn parse_stmt(sql: &str) -> Option<SqlStmt> { ... }
4. Constants / Type Aliases
rust
Â§çÂà∂
ÁºñËæë
/// Default duration threshold (in ms) for slow query classification.
pub const DEFAULT_SLOW_QUERY_THRESHOLD: u64 = 300;
rust
Â§çÂà∂
ÁºñËæë
/// Alias for a list of formatted DDL warnings.
pub type DdlWarnings = Vec<CheckResult>;
5. Errors
‰ΩøÁî® thiserror + ÊñáÊ°£Ê≥®ÈáäËØ¥ÊòéÈîôËØØÂê´‰πâ„ÄÇ

rust
Â§çÂà∂
ÁºñËæë
/// Errors that can occur while parsing a slow log file.
#[derive(thiserror::Error, Debug)]
pub enum SlowLogParseError {
    /// File could not be opened or read.
    #[error("failed to read log file")]
    Io(#[from] std::io::Error),

    /// Log entry could not be parsed.
    #[error("invalid slow log format")]
    InvalidFormat,
}
6. Tests
ÊµãËØïÂáΩÊï∞ÂèØÁÆÄË¶ÅËØ¥ÊòéÊµãËØïÁõÆÊ†á„ÄÇ

rust
Â§çÂà∂
ÁºñËæë
#[test]
/// Ensures that `parse_stmt` correctly detects CREATE TABLE statements.
fn test_parse_create_table() {
    ...
}
üîÅ Ê≥®ÈáäÈ£éÊ†ºÂª∫ËÆÆÔºàÊúÄ‰Ω≥ÂÆûË∑µÔºâ
È°πÁõÆ	Êé®ËçêÂÅöÊ≥ï
ÂëΩÂêç	‰ΩøÁî®Ê∏ÖÊô∞‰∏ÄËá¥ÁöÑËã±ÊñáÂêçÁß∞ÔºåÈÅøÂÖçÁº©ÂÜô
Âä®ËØç	ÂáΩÊï∞/ÊñπÊ≥ïÈ¶ñÂè•Â∫î‰ª•‚ÄúDoes/Parses/Returns...‚ÄùÁ≠âÂä®ËØçÂºÄÂ§¥
ÊÆµËêΩÁªìÊûÑ	Á¨¨‰∏ÄÊÆµÁÆÄË¶ÅÊèèËø∞Áî®ÈÄîÔºåÂêéÁª≠ÊÆµËêΩÁî® Markdown Ê†áÈ¢ò/ÂàóË°®ÂàÜÂ±Ç
Á§∫‰æã	ÂØπÂ§çÊùÇË°å‰∏∫‰ΩøÁî® # Examples Âùó‰∏æ‰æãËØ¥Êòé

Á§∫‰æãÔºö
rust
Â§çÂà∂
ÁºñËæë
/// Resolves all registered services that implement the specified trait.
///
/// This function is typically used by plugins to access capabilities
/// provided by other plugins via the shared `ServiceRegistry`.
///
/// # Examples
/// ```
/// let svc = registry.resolve::<dyn DdlCheckerService>().unwrap();
/// ```
üö´ Á¶ÅÊ≠¢‰∫ãÈ°π
‚ùå Á¶ÅÊ≠¢Âú®‰ªª‰Ωï‰ª£Á†ÅÊ≥®Èáä‰∏≠‰ΩøÁî®‰∏≠Êñá

‚ùå ‰∏çË¶Å‰ΩøÁî®Ë°åÂÜÖ // ‰∏≠ÊñáËØ¥Êòé

‚ùå ‰∏çË¶ÅÂ∞ÜËÆæËÆ°ÊÄß„ÄÅÈÄªËæëÊÄßÁöÑÊèèËø∞ËóèÂú®‰ª£Á†Å‰∏≠ÔºåÂ∫îÁßªËá≥ËÆæËÆ°ÊñáÊ°£Ôºà/docsÔºâ

üì¶ Êèí‰ª∂Ê≥®ÈáäÁ§∫‰æãÔºàÂÆåÊï¥Ôºâ
rust
Â§çÂà∂
ÁºñËæë
/// A plugin that checks for lossy or unsafe DDL statements.
///
/// This plugin parses SQL files or CLI input and flags any DDL operations
/// that could result in data loss (e.g., `DROP COLUMN`, `MODIFY COLUMN` with shrink).
pub struct LossyDdlPlugin;

impl Plugin for LossyDdlPlugin {
    fn name(&self) -> &str { "lossy_ddl" }

    /// Registers the plugin with the provided runtime context.
    ///
    /// This includes command handlers, service trait implementations,
    /// and any event subscriptions if needed.
    fn register(&mut self, ctx: &mut PluginContext) {
        ctx.register_command("check-lossy-ddl", LossyDdlHandler);
        ctx.service_registry
            .register::<dyn DdlCheckerService>(Arc::new(LossyDdlServiceImpl));
    }
}
üß™ ÂºÄÂèëÊúüÈó¥ËæÖÂä©Ê≥®ÈáäËßÑËåÉ
ÂºÄÂèëÊúüÈó¥ÂèØ‰ΩøÁî®‰∏¥Êó∂ TODO / FIXME Ê≥®ÈáäÔºå‰ΩÜÂøÖÈ°ªÊòØËã±ÊñáÔºö

rust
Â§çÂà∂
ÁºñËæë
// TODO: Implement fallback when service not found.
// FIXME: This fails on malformed input; needs better validation.
ÂºÄÂèëÂÆåÊàêÂêéÂ∫îÊ∏ÖÁêÜÂ§ö‰ΩôÊ≥®ÈáäÔºåÂπ∂‰øùÁïôÂøÖË¶ÅÁöÑÊñáÊ°£Ê≥®ÈáäÂíåÁª¥Êä§ÊÄßËØ¥Êòé„ÄÇ

üóÇÔ∏è Êé®ËçêÂ∑•ÂÖ∑Èìæ
Â∑•ÂÖ∑	ËØ¥Êòé
rust-analyzer	ÊèêÁ§∫ÊñáÊ°£ÁªìÊûÑ„ÄÅË∑≥ËΩ¨‰∏éË°•ÂÖ®
cargo doc	ÁºñËØë API ÊñáÊ°£ (target/doc)
cargo clippy	ÊèêÁ§∫Ê≥®ÈáäÊ†ºÂºèÈîôËØØ‰∏éÊú™‰ΩøÁî®ÊñáÊ°£